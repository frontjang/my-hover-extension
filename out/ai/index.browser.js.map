{"version":3,"file":"index.browser.js","sourceRoot":"","sources":["../../src/ai/index.browser.ts"],"names":[],"mappings":"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","sourcesContent":["import { CustomAI } from \"./CustomAI\";\nimport { BrowserAuthClient } from \"./browserAuth\";\nimport { _shimInitialized } from \"../browser-shim\";\nimport { getEnvVar, requireEnvVar } from \"../config/env\";\nimport { buildCustomAIAuthorizationUrl } from \"./customEnv\";\nimport { logCustomAIDebug, logCustomAIWarning } from \"./customAiDebug\";\n\nexport { type CustomAIModel } from \"../model\";\nexport { _shimInitialized } from \"../browser-shim\";\n\nexport class CustomAIBrowser extends CustomAI {\n  private readonly browserAuth: BrowserAuthClient;\n\n  constructor(...args: ConstructorParameters<typeof CustomAI>) {\n    super(...args);\n    const globalRef = typeof globalThis === \"object\" ? (globalThis as Record<string, unknown>) : {};\n    const browserWindow = globalRef.window as { location: { origin: string } } | undefined;\n    const origin = browserWindow?.location?.origin ?? \"\";\n    const redirectUri =\n      getEnvVar(\"CUSTOM_REDIRECT_URI\") ?? \"http://localhost:3000/auth/callback\";\n\n    const defaultScope = CustomAI.defaultScope;\n\n    logCustomAIDebug(\"Initializing CustomAIBrowser\", {\n      origin,\n      redirectUri,\n      hasDefaultScope: !!defaultScope,\n    });\n\n    this.browserAuth = new BrowserAuthClient({\n      clientId: requireEnvVar(\"CUSTOM_CLIENT_ID\"),\n      tenantId: requireEnvVar(\"CUSTOM_TENANT_ID\"),\n      authority: getEnvVar(\"CUSTOM_AUTHORITY\"),\n      redirectUri,\n      postLogoutRedirectUri: origin ? `${origin}/` : undefined,\n      cacheLocation: \"sessionStorage\",\n      defaultScopes: defaultScope ? [defaultScope] : [],\n      interactionType: \"popup\",\n    });\n  }\n\n  async customaiHydrateFromRedirect(): Promise<void> {\n    logCustomAIDebug(\"Hydrating CustomAIBrowser from redirect\");\n    await this.browserAuth.hydrateFromRedirect();\n    if (this.browserAuth.isAuthenticated()) {\n      const scopes = CustomAI.defaultScope ? [CustomAI.defaultScope] : undefined;\n      if (scopes) {\n        logCustomAIDebug(\"CustomAIBrowser detected authenticated session after redirect\", {\n          scopes,\n        });\n        const accessToken = await this.browserAuth.getAccessToken(scopes);\n        this.setAzureAuthToken(accessToken);\n      }\n    }\n  }\n\n  async customaiAuthenticateInBrowser(scopes = [CustomAI.defaultScope]): Promise<void> {\n    const filteredScopes = scopes.filter((scope): scope is string => !!scope);\n    if (filteredScopes.length === 0) {\n      throw new Error(\"At least one scope must be provided for browser authentication.\");\n    }\n    if (!_shimInitialized) {\n      const authDetails = buildCustomAIAuthorizationUrl();\n      if (authDetails.url) {\n        try {\n          const parsed = new URL(authDetails.url);\n          logCustomAIWarning(\n            \"Browser shim is not initialized; authentication must occur in an external window.\",\n            {\n              host: parsed.origin,\n              path: parsed.pathname,\n            }\n          );\n        } catch (error) {\n          logCustomAIWarning(\n            \"Browser shim is not initialized; authentication must occur in an external window.\",\n            {\n              url: authDetails.url,\n              error: error instanceof Error ? error.message : String(error),\n            }\n          );\n        }\n      } else {\n        logCustomAIWarning(\n          \"Browser shim is not initialized and CustomAI auth URL could not be constructed.\",\n          {\n            missing: authDetails.missing,\n          }\n        );\n      }\n    }\n    logCustomAIDebug(\"Starting CustomAIBrowser interactive authentication\", {\n      scopes: filteredScopes,\n    });\n    const accessToken = await this.browserAuth.getAccessToken(filteredScopes);\n    this.setAzureAuthToken(accessToken);\n    logCustomAIDebug(\"CustomAIBrowser authentication complete\", {\n      receivedToken: !!accessToken,\n      tokenLength: accessToken.length,\n    });\n  }\n\n  customaiIsAuthenticated(): boolean {\n    const authenticated = this.browserAuth.isAuthenticated();\n    logCustomAIDebug(\"CustomAIBrowser authentication status queried\", {\n      authenticated,\n    });\n    return authenticated;\n  }\n\n  customaiAuthenticatedUser(): string {\n    const username = this.browserAuth.getAccount()?.username ?? \"Unknown\";\n    logCustomAIDebug(\"CustomAIBrowser resolved authenticated user\", { username });\n    return username;\n  }\n\n  async customaiLogout(): Promise<void> {\n    logCustomAIDebug(\"CustomAIBrowser logout requested\");\n    await this.browserAuth.logout();\n    this.setAzureAuthToken(\"\");\n    logCustomAIDebug(\"CustomAIBrowser logout complete\");\n  }\n\n  async ericaiHydrateFromRedirect(): Promise<void> {\n    logCustomAIDebug(\"Legacy EricAI hydrate invoked\");\n    await this.customaiHydrateFromRedirect();\n  }\n\n  async ericaiAuthenticateInBrowser(scopes?: Array<string | undefined>): Promise<void> {\n    logCustomAIDebug(\"Legacy EricAI authenticate invoked\", { scopes });\n    if (!scopes) {\n      await this.customaiAuthenticateInBrowser();\n      return;\n    }\n    const filteredScopes = scopes.filter((scope): scope is string => !!scope);\n    await this.customaiAuthenticateInBrowser(filteredScopes.length ? filteredScopes : undefined);\n  }\n\n  ericaiIsAuthenticated(): boolean {\n    logCustomAIDebug(\"Legacy EricAI auth status check\");\n    return this.customaiIsAuthenticated();\n  }\n\n  ericaiAuthenticatedUser(): string {\n    logCustomAIDebug(\"Legacy EricAI user lookup\");\n    return this.customaiAuthenticatedUser();\n  }\n\n  async ericaiLogout(): Promise<void> {\n    logCustomAIDebug(\"Legacy EricAI logout invoked\");\n    await this.customaiLogout();\n  }\n}\n\nexport { CustomAIBrowser as EricAIBrowser };\nexport const EricAI: typeof CustomAIBrowser = CustomAIBrowser;\n\nexport default CustomAIBrowser;\n"]}